<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì¢Œ/ìš° ì˜ìƒ ì„ íƒ</title>
<style>
body { background:#111; color:white; text-align:center; padding:40px; font-family:sans-serif; }
select,button { padding:10px; margin:10px; border-radius:6px; }
.progress { width:80%; height:30px; display:none; margin-top:20px; }
.sync-info { margin-top:15px; color:#0f0; font-size:14px; }
</style>
</head>

<body>

<h2>ğŸ¬ êµì°¨ í¸ì§‘ìš© ì˜ìƒ ì„ íƒ</h2>

<p>ì¢Œì¸¡ / ìš°ì¸¡ ì¹´ë©”ë¼ ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>

<select id="left">
    <option value="">-- ì¢Œì¸¡ ì˜ìƒ ì„ íƒ --</option>
    {% for v in videos %}
    <option value="{{v}}">{{v}}</option>
    {% endfor %}
</select><br>

<select id="right">
    <option value="">-- ìš°ì¸¡ ì˜ìƒ ì„ íƒ --</option>
    {% for v in videos %}
    <option value="{{v}}">{{v}}</option>
    {% endfor %}
</select><br>

<div id="syncMsg"></div>

<button onclick="goNext()">ë‹¤ìŒ ë‹¨ê³„</button>

<script>
let syncDB = {{ sync_db|tojson if sync_db is defined else '{}' }};

async function goNext() {
    const left  = document.getElementById("left").value;
    const right = document.getElementById("right").value;

    if (!left || !right) {
        alert("ì¢Œ/ìš° ì˜ìƒì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    // 1ï¸âƒ£ YOLO ë¶„ì„ íŒŒì¼ ìˆëŠ”ì§€ ì²´í¬
    let saved = [];
    try {
        saved = await fetch("/saved", { cache: "no-store" }).then(r => r.json());
    } catch (e) {
        alert("ì €ì¥ëœ ë¶„ì„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        return;
    }

    const hasLeft  = saved.some(s => s.video === left);
    const hasRight = saved.some(s => s.video === right);

    if (!hasLeft || !hasRight) {
        alert("ì•„ì§ YOLO ë¶„ì„ì´ ëë‚˜ì§€ ì•Šì€ ì˜ìƒì´ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.");
        return;
    }

    // 2ï¸âƒ£ ì‹±í¬ ì €ì¥ ì—¬ë¶€ í™•ì¸
    let syncDB = await fetch("/api_sync_list").then(r => r.json());
    let key = `${left}__${right}`;

    if (syncDB[key] !== undefined) {
        const offset = syncDB[key];

        const useOld = confirm(
            `ì´ì „ì— ì‹±í¬ ì‘ì—… ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤.\n\n` +
            `ì €ì¥ëœ ì‹±í¬ offset = ${offset} ì´ˆ\n\n` +
            `ë¶ˆëŸ¬ì˜¤ë ¤ë©´ [í™•ì¸], ìƒˆë¡œ ë§ì¶”ë ¤ë©´ [ì·¨ì†Œ]`
        );

        if (useOld) {
            window.location.href =
                `/full?left=${encodeURIComponent(left)}` +
                `&right=${encodeURIComponent(right)}` +
                `&use_saved_sync=1`;
            return;
        }
    }

    // 3ï¸âƒ£ ê¸°ì¡´ ì‹±í¬ ì—†ê±°ë‚˜ ìƒˆë¡œ ë§Œë“¤ê¸°ë¥¼ ì„ íƒ
    window.location.href =
        `/full_sync?left=${encodeURIComponent(left)}` +
        `&right=${encodeURIComponent(right)}`;
}
</script>

</body>
</html>
