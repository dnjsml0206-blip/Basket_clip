<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í•˜ì´ë¼ì´íŠ¸ í¸ì§‘ê¸°</title>
  <style>
    body {
      background:#000;
      color:#fff;
      font-family:sans-serif;
      text-align:center;
      margin:0;
      padding:20px 0 40px;
    }
    h2 { margin-top:10px; }
    
    /* ğŸ”¥ ë””ë²„ê¹… ë°•ìŠ¤ */
    .debug-box {
      background:#222;
      padding:10px;
      margin:10px auto;
      max-width:80%;
      text-align:left;
      font-size:12px;
      border:1px solid #444;
      border-radius:4px;
    }
    
    video {
      max-width:80%;
      width:80%;
      height:auto;
      max-height:70vh;
      background:#000;
      border-radius:8px;
      display:block;
      margin:0 auto;
    }
    
    #videoError {
      color:#f55;
      margin:10px;
      font-size:14px;
    }
    
    /* íƒ€ì„ë¼ì¸ ë˜í¼ (ìŠ¤í¬ë¡¤ ì˜ì—­) */
    #timelineWrapper {
      width: 80%;
      margin: 20px auto 5px auto;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      background: transparent;
      padding-bottom: 6px;
    }

    /* ì‹¤ì œ íšŒìƒ‰ ë§‰ëŒ€ */
    #timeline {
      height:40px;
      background:#333;
      min-width: 800px;
      position:relative;
      border-radius:6px;
      overflow:hidden;
      user-select:none;
    }

    /* í˜„ì¬ ì¬ìƒ ìœ„ì¹˜ ë§‰ëŒ€ (í°ìƒ‰ ì¤„) */
    #currentTimeBar {
      position:absolute;
      top:0;
      bottom:0;
      width:2px;
      background:#fff;
      pointer-events:none;
      z-index:5;
    }

    .clip {
      position:absolute;
      height:40%;
      top:30%;
      border-radius:4px;
      cursor:move;
      box-sizing:border-box;
    }
    .clip.red  { background:rgba(255,0,0,0.6); }
    .clip.blue { background:rgba(0,128,255,0.6); }

    .handle {
      position:absolute;
      top:-10%;
      width:4px;
      height:120%;
      background:#ccc;
      cursor:ew-resize;
    }
    .handle.left  { left:0; }
    .handle.right { right:0; }

    .label {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      font-size:12px;
      font-weight:bold;
      color:#fff;
      text-shadow:0 0 2px #000;
      pointer-events:none;
    }

    #ruler {
      width:80%;
      margin:0 auto 20px auto;
      position:relative;
      height:18px;
      font-size:10px;
      color:#ccc;
    }
    .tick {
      position:absolute;
      top:0;
      height:100%;
      border-left:1px solid #555;
      padding-left:2px;
      white-space:nowrap;
    }

    #selectionBox {
      position:absolute;
      top:0;
      height:100%;
      background:rgba(255,255,255,0.12);
      border:1px dashed #fff;
      pointer-events:none;
      z-index:4;
    }

    button {
      padding:8px 12px;
      margin:5px;
      border:none;
      border-radius:6px;
      background:#222;
      color:#fff;
      cursor:pointer;
    }
    button:hover { background:#444; }

    select {
      padding:5px 8px;
      border-radius:4px;
      border:none;
      background:#222;
      color:#fff;
    }

    #exportProgressContainer {
      margin-top:15px;
      display:none;
    }

    #exportProgressBar {
      width:60%;
      height:18px;
    }

    a { color:#0ff; }
  </style>
</head>
<body>
  <!-- ğŸ”¥ ë””ë²„ê¹… ì •ë³´ í‘œì‹œ -->
  <div class="debug-box">
    <strong>ğŸ” ë””ë²„ê¹… ì •ë³´:</strong><br>
    Video Name: <code>{{ video }}</code><br>
    Video URL: <code>/videos/{{ video }}</code><br>
    Clips Count: {{ clips|length }}<br>
    <button onclick="testVideoUrl()" style="margin-top:5px;">Test Video URL</button>
    <button onclick="testR2Files()">Check R2 Files</button>
    <div id="testResult" style="margin-top:5px; color:#0f0;"></div>
  </div>

  <h2>ğŸ¬ í•˜ì´ë¼ì´íŠ¸ í¸ì§‘ê¸° - {{ video }}</h2>

  <video id="resultVideo" controls preload="metadata">
    <source src="/videos/{{ video }}" type="video/mp4">
    ë¸Œë¼ìš°ì €ê°€ video íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
  </video>

  <!-- ğŸ”¥ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
  <div id="videoError"></div>

  <!-- íƒ€ì„ë¼ì¸ -->
  <div id="timelineWrapper">
    <div id="timeline">
      <div id="currentTimeBar"></div>
    </div>
  </div>

  <!-- ëˆˆê¸ˆì -->
  <div id="ruler"></div>

  <!-- êµ¬ê°„ í¸ì§‘ ë²„íŠ¼ -->
  <div style="margin-top:10px;">
    <div style="display:inline-flex; align-items:center; gap:10px; margin-right:10px;">
      <div id="colorRedBtn" onclick="setCurrentColor('red')"
           style="width:18px; height:18px; border-radius:50%; background:#ff4444; cursor:pointer; border:2px solid #fff;"></div>
      <div id="colorBlueBtn" onclick="setCurrentColor('blue')"
           style="width:18px; height:18px; border-radius:50%; background:#3399ff; cursor:pointer;"></div>
    </div>

    <button onclick="addClip()">+ êµ¬ê°„ ì¶”ê°€</button>
    <button onclick="deleteClip()">- ì„ íƒ êµ¬ê°„ ì‚­ì œ</button>
    <button onclick="setSelectedColor('red')">ğŸ”´ ë¹¨ê°•</button>
    <button onclick="setSelectedColor('blue')">ğŸ”µ íŒŒë‘</button>
    <button onclick="playHighlights()">ğŸ¬ í•˜ì´ë¼ì´íŠ¸ë§Œ ì¬ìƒ</button>
  </div>

  <div style="margin-top:10px;">
    <button onclick="downloadHighlight()">âœ¨ ì „ì²´ í•˜ì´ë¼ì´íŠ¸ ë‹¤ìš´</button>
    <button onclick="downloadColorHighlight('red')">ğŸ”´ ë¹¨ê°• í•˜ì´ë¼ì´íŠ¸</button>
    <button onclick="downloadColorHighlight('blue')">ğŸ”µ íŒŒë‘ í•˜ì´ë¼ì´íŠ¸</button>
  </div>

  <div style="margin-top:10px;">
    <span>ë§ˆí‚¹ ë²ˆí˜¸ ì„ íƒ: </span>
    <select id="markerSelect">
      <option value="">-- ë²ˆí˜¸ ì„ íƒ --</option>
    </select>
    <button onclick="downloadPlayerHighlight()">ğŸ‘¤ í”Œë ˆì´ì–´ë³„ í•˜ì´ë¼ì´íŠ¸</button>
    <button onclick="saveAnalysis()">ğŸ’¾ ì €ì¥</button>
  </div>

  <div id="exportProgressContainer">
    <div>í•˜ì´ë¼ì´íŠ¸ ë Œë”ë§ ì¤‘... <span id="exportStatusText"></span></div>
    <progress id="exportProgressBar" value="0" max="100"></progress><br>
    <button id="exportStopBtn" onclick="stopExport()">ì¤‘ì§€</button>
  </div>

  <div style="margin-top:15px;">
    <a href="/">â¬… ë¶„ì„ í™”ë©´ìœ¼ë¡œ</a>
  </div>

<script>
/* ğŸ”¥ ë””ë²„ê¹… í•¨ìˆ˜ë“¤ */
async function testVideoUrl() {
  const videoName = "{{ video }}";
  const testResult = document.getElementById("testResult");
  testResult.textContent = "Testing...";
  
  try {
    const response = await fetch(`/videos/${encodeURIComponent(videoName)}`, {
      method: 'HEAD'
    });
    
    if (response.ok) {
      testResult.innerHTML = `âœ… Video URL accessible (Status: ${response.status})`;
      testResult.style.color = "#0f0";
    } else {
      testResult.innerHTML = `âŒ Video URL error (Status: ${response.status})`;
      testResult.style.color = "#f55";
    }
  } catch (err) {
    testResult.innerHTML = `âŒ Network error: ${err.message}`;
    testResult.style.color = "#f55";
  }
}

async function testR2Files() {
  const testResult = document.getElementById("testResult");
  testResult.textContent = "Checking R2...";
  
  try {
    const response = await fetch('/debug/r2_files');
    const files = await response.json();
    testResult.innerHTML = `ğŸ“ R2 Files (${files.length}): ${files.join(', ')}`;
    testResult.style.color = "#0ff";
  } catch (err) {
    testResult.innerHTML = `âŒ R2 check failed: ${err.message}`;
    testResult.style.color = "#f55";
  }
}

/* ğŸ”¥ ë¹„ë””ì˜¤ ì—ëŸ¬ ê°ì§€ */
const videoEl = document.getElementById("resultVideo");
const videoError = document.getElementById("videoError");

videoEl.addEventListener("error", (e) => {
  console.error("âŒ Video error:", videoEl.error);
  videoError.innerHTML = `
    âŒ ë¹„ë””ì˜¤ ë¡œë”© ì‹¤íŒ¨<br>
    Error Code: ${videoEl.error?.code || 'unknown'}<br>
    Message: ${videoEl.error?.message || 'unknown'}<br>
    <button onclick="testVideoUrl()" style="margin-top:5px;">ì¬í…ŒìŠ¤íŠ¸</button>
  `;
});

videoEl.addEventListener("loadstart", () => {
  console.log("âœ… Video loading started");
  videoError.textContent = "ë¹„ë””ì˜¤ ë¡œë”© ì¤‘...";
  videoError.style.color = "#0ff";
});

videoEl.addEventListener("loadeddata", () => {
  console.log("âœ… Video loaded successfully");
  videoError.textContent = "âœ… ë¹„ë””ì˜¤ ë¡œë“œ ì™„ë£Œ";
  videoError.style.color = "#0f0";
  setTimeout(() => { videoError.textContent = ""; }, 3000);
});

videoEl.addEventListener("loadedmetadata", () => {
  console.log("âœ… Video metadata loaded, duration:", videoEl.duration);
});

/* ===========================
   ê¸°ë³¸ ìƒíƒœ ë³€ìˆ˜ë“¤
   =========================== */
let currentColor = "red";
function setCurrentColor(c) {
  currentColor = c;
  document.getElementById("colorRedBtn").style.border =
      (c === "red") ? "2px solid #fff" : "none";
  document.getElementById("colorBlueBtn").style.border =
      (c === "blue") ? "2px solid #fff" : "none";
}

const videoName = "{{ video }}";
let clipsData = {{ clips|tojson|safe }};
if (!Array.isArray(clipsData)) clipsData = [];

console.log("ğŸ“Š Loaded clips:", clipsData);

// ê° í´ë¦½ì— ê³ ìœ  id ë¶€ì—¬
let nextClipId = 1;
let clips = clipsData.map(c => ({
  id: nextClipId++,
  start: c.start,
  end: c.end,
  color: c.color || "red",
  label: c.label || null,
  el: null
}));

const timelineWrapper = document.getElementById("timelineWrapper");
const timeline = document.getElementById("timeline");
const ruler = document.getElementById("ruler");

let selectedClips = new Set();
let draggingClip = null;
let resizingClip = null;
let resizingSide = null;
let dragOffsetX = 0;

let isSelecting = false;
let selectionBox = null;
let selectionStartX = 0;

let highlightQueue = [];
let currentIndex = 0;
let playingHighlights = false;
let rafId = null;

let currentLabelInput = "";
let labelInputTimer = null;

// export ê´€ë ¨
let currentJobId = null;
let exportPolling = false;

/* ===========================
   ì˜ìƒ ë©”íƒ€ë°ì´í„° ë¡œë”© í›„ ì´ˆê¸°í™”
   =========================== */
videoEl.addEventListener("loadedmetadata", () => {
  const duration = videoEl.duration || 0;
  console.log("ğŸ“¹ Video duration:", duration);
  
  if (duration > 0) {
    const PX_PER_SEC = 10;
    const pixelWidth = Math.max(800, duration * PX_PER_SEC);
    timeline.style.width = pixelWidth + "px";

    renderTimeline();
    buildRuler();
    startTimeBar();
  }
});

/* ===========================
   íƒ€ì„ë¼ì¸ ë Œë”ë§
   =========================== */
function renderTimeline() {
  const bar = document.getElementById("currentTimeBar");

  Array.from(timeline.children).forEach(ch => {
    if (ch !== bar) timeline.removeChild(ch);
  });

  const dur = videoEl.duration || 0;
  if (!dur) return;

  const tlWidth = timeline.offsetWidth;
  const pxPerSec = tlWidth / dur;

  clips.forEach(c => {
    const div = document.createElement("div");
    div.className = "clip " + c.color;

    const left = c.start * pxPerSec;
    const width = (c.end - c.start) * pxPerSec;

    div.style.left = left + "px";
    div.style.width = width + "px";

    c.el = div;
    div.clipData = c;

    addHandles(div, c);
    timeline.appendChild(div);
  });

  updateSelectionStyles();
  refreshMarkerOptions();
}

/* ===========================
   ëˆˆê¸ˆì
   =========================== */
function buildRuler() {
  ruler.innerHTML = "";
  const dur = videoEl.duration || 0;
  if (!dur) return;

  const step = dur > 600 ? 60 : (dur > 180 ? 30 : 10);

  for (let t = 0; t <= dur + 0.001; t += step) {
    const tick = document.createElement("div");
    tick.className = "tick";
    tick.style.left = (t / dur * 100) + "%";
    tick.textContent = formatTime(t);
    ruler.appendChild(tick);
  }
}

function formatTime(t) {
  t = Math.floor(t);
  const m = Math.floor(t / 60);
  const s = t % 60;
  return m + ":" + String(s).padStart(2,"0");
}

/* ===========================
   í´ë¦½ í•¸ë“¤ / ì´ë²¤íŠ¸
   =========================== */
function addHandles(div, clipData) {
  const leftH = document.createElement("div");
  leftH.className = "handle left";
  const rightH = document.createElement("div");
  rightH.className = "handle right";
  div.appendChild(leftH);
  div.appendChild(rightH);

  div.addEventListener("click", e => {
    if (e.target.classList.contains("handle")) return;

    if (!e.ctrlKey && !e.metaKey) selectedClips.clear();
    if (selectedClips.has(clipData)) selectedClips.delete(clipData);
    else selectedClips.add(clipData);

    updateSelectionStyles();
  });

  div.addEventListener("dblclick", e => {
    refreshClipTimes();

    highlightQueue = clips.slice().sort((a,b)=>a.start - b.start);
    currentIndex = highlightQueue.findIndex(c => c.id === clipData.id);
    if (currentIndex < 0) currentIndex = 0;

    playingHighlights = true;
    videoEl.currentTime = clipData.start;
    videoEl.play();

    startHighlightLoop();
  });

  div.addEventListener("mousedown", e => {
    if (e.target.classList.contains("handle")) return;
    const rect = timeline.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left - div.offsetLeft;
    draggingClip = div;
  });

  leftH.addEventListener("mousedown", e => {
    e.stopPropagation();
    resizingClip = div;
    resizingSide = "left";
  });
  rightH.addEventListener("mousedown", e => {
    e.stopPropagation();
    resizingClip = div;
    resizingSide = "right";
  });
}

/* ===========================
   ë§ˆìš°ìŠ¤ ì´ë™ / ë“œë˜ê·¸ / ë¦¬ì‚¬ì´ì¦ˆ / ë°•ìŠ¤ ì„ íƒ
   =========================== */
document.addEventListener("mousemove", e => {
  const rect = timeline.getBoundingClientRect();
  const dur = videoEl.duration || 0;
  if (!dur) return;

  const tlWidth = timeline.offsetWidth;
  const pxPerSec = tlWidth / dur;

  if (draggingClip) {
    let left = e.clientX - rect.left - dragOffsetX;
    if (left < 0) left = 0;
    if (left > tlWidth - draggingClip.offsetWidth)
      left = tlWidth - draggingClip.offsetWidth;

    draggingClip.style.left = left + "px";

    const c = draggingClip.clipData;
    const start = left / pxPerSec;
    const end = (left + draggingClip.offsetWidth) / pxPerSec;

    c.start = Math.round(start*100)/100;
    c.end = Math.round(end*100)/100;
    return;
  }

  if (resizingClip) {
    const left = resizingClip.offsetLeft;
    const width = resizingClip.offsetWidth;
    const mouse = e.clientX - rect.left;

    let newLeft = left;
    let newWidth = width;

    if (resizingSide === "left") {
      newLeft = Math.min(mouse, left+width-10);
      if (newLeft < 0) newLeft = 0;
      newWidth = (left+width) - newLeft;
    } else {
      newWidth = mouse - left;
      if (newWidth < 10) newWidth = 10;
    }

    if (newLeft + newWidth > tlWidth)
      newWidth = tlWidth - newLeft;

    resizingClip.style.left = newLeft + "px";
    resizingClip.style.width = newWidth + "px";

    const c = resizingClip.clipData;
    c.start = Math.round((newLeft/pxPerSec)*100)/100;
    c.end = Math.round(((newLeft+newWidth)/pxPerSec)*100)/100;
    return;
  }

  if (isSelecting && selectionBox) {
    const minX = Math.min(selectionStartX, e.clientX);
    const maxX = Math.max(selectionStartX, e.clientX);
    selectionBox.style.left = (minX - rect.left) + "px";
    selectionBox.style.width = (maxX - minX) + "px";
  }
});

document.addEventListener("mouseup", e => {
  draggingClip = null;
  resizingClip = null;
  resizingSide = null;

  if (isSelecting && selectionBox) {
    const rect = timeline.getBoundingClientRect();
    const minX = Math.min(selectionStartX, e.clientX);
    const maxX = Math.max(selectionStartX, e.clientX);

    selectedClips.clear();

    clips.forEach(c => {
      if (!c.el) return;
      const cr = c.el.getBoundingClientRect();
      const cx = (cr.left + cr.right) / 2;
      if (cx >= minX && cx <= maxX) selectedClips.add(c);
    });

    updateSelectionStyles();
    selectionBox.remove();
    selectionBox = null;
    isSelecting = false;
  }
});

timeline.addEventListener("mousedown", e => {
  if (e.target !== timeline) return;
  isSelecting = true;

  const rect = timeline.getBoundingClientRect();
  selectionStartX = e.clientX;

  selectionBox = document.createElement("div");
  selectionBox.id = "selectionBox";
  selectionBox.style.left = (e.clientX - rect.left) + "px";
  selectionBox.style.width = "0px";
  timeline.appendChild(selectionBox);
});

function updateSelectionStyles() {
  clips.forEach(c => {
    if (!c.el) return;
    c.el.style.outline = selectedClips.has(c)
        ? "2px solid #fff"
        : "none";
  });
}

/* ===========================
   currentTimeBar ìœ„ì¹˜ ì—…ë°ì´íŠ¸
   =========================== */
function startTimeBar() {
  function loop() {
    const bar = document.getElementById("currentTimeBar");
    const dur = videoEl.duration || 0;
    const t = videoEl.currentTime || 0;

    if (dur > 0) {
      const tlWidth = timeline.offsetWidth;
      const x = (t / dur) * tlWidth;
      bar.style.left = x + "px";
    } else {
      bar.style.left = "0px";
    }

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
}

/* ===========================
   ì˜ìƒ ì¬ìƒ â†’ timeline ìë™ ìŠ¤í¬ë¡¤
   =========================== */
videoEl.addEventListener("timeupdate", () => {
  const dur = videoEl.duration || 0;
  if (!dur) return;

  const tlWidth = timeline.offsetWidth;
  const wrapWidth = timelineWrapper.offsetWidth;

  const x = (videoEl.currentTime / dur) * tlWidth;
  let scrollLeft = x - wrapWidth / 2;

  if (tlWidth > wrapWidth) {
    if (scrollLeft < 0) scrollLeft = 0;
    if (scrollLeft > tlWidth - wrapWidth) scrollLeft = tlWidth - wrapWidth;
    timelineWrapper.scrollLeft = scrollLeft;
  }
});

/* ===========================
   í´ë¦½ ì¶”ê°€ / ì‚­ì œ / ìƒ‰ìƒ / ë¼ë²¨
   =========================== */
function addClip() {
  const dur = videoEl.duration || 0;
  const now = videoEl.currentTime || 0;
  if (!dur) {
    alert("ì˜ìƒì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  const len = 7;
  let start = now - len;
  let end = now;

  if (start < 0) start = 0;
  if (end > dur) end = dur;

  const c = {
    id: nextClipId++,
    start: Math.round(start*100)/100,
    end: Math.round(end*100)/100,
    color: currentColor,
    label: null,
    el: null
  };

  clips.push(c);
  renderTimeline();
}

function deleteClip() {
  clips = clips.filter(c => !selectedClips.has(c));
  selectedClips.clear();
  renderTimeline();
}

function setSelectedColor(color) {
  selectedClips.forEach(c => {
    if (!c.el) return;
    c.el.classList.remove("red","blue");
    c.el.classList.add(color);
    c.color = color;
  });
}

function applyLabelToSelected(label) {
  selectedClips.forEach(c => {
    c.label = label;
    if (!c.el) return;
    let span = c.el.querySelector(".label");
    if (!span) {
      span = document.createElement("div");
      span.className = "label";
      c.el.appendChild(span);
    }
    span.textContent = label;
  });
  refreshMarkerOptions();
}

function handleDigitKey(d) {
  currentLabelInput += d;
  if (currentLabelInput.length > 2) currentLabelInput = d;
  if (selectedClips.size > 0) {
    applyLabelToSelected(currentLabelInput);
  }
  if (labelInputTimer) clearTimeout(labelInputTimer);
  labelInputTimer = setTimeout(() => { currentLabelInput = ""; }, 1500);
}

function refreshMarkerOptions() {
  const markerSelect = document.getElementById("markerSelect");
  const labels = Array.from(
    new Set(clips.map(c => c.label).filter(v => v !== null && v !== ""))
  ).sort((a,b) => parseInt(a) - parseInt(b));

  markerSelect.innerHTML = '<option value="">-- ë²ˆí˜¸ ì„ íƒ --</option>';
  labels.forEach(lbl => {
    const opt = document.createElement("option");
    opt.value = lbl;
    opt.textContent = lbl;
    markerSelect.appendChild(opt);
  });
}

function refreshClipTimes() {
  const dur = videoEl.duration || 0;
  const tlWidth = timeline.offsetWidth;
  const pxPerSec = tlWidth / (dur || 1);

  clips.forEach(c => {
    if (!c.el) return;
    const left = parseFloat(c.el.style.left) || 0;
    const width = parseFloat(c.el.style.width) || 0;
    c.start = Math.round((left/pxPerSec)*100)/100;
    c.end   = Math.round(((left+width)/pxPerSec)*100)/100;
  });
}

function saveAnalysis() {
  refreshClipTimes();

  clips.forEach(c => {
    if (!c.el) return;
    if (c.el.classList.contains("red")) c.color = "red";
    if (c.el.classList.contains("blue")) c.color = "blue";
    const span = c.el.querySelector(".label");
    if (span) c.label = span.textContent;
  });

  const data = {
    video: videoName,
    clips: clips.map(c => ({
      start: c.start,
      end: c.end,
      color: c.color,
      label: c.label
    }))
  };

  fetch("/saved", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  }).then(()=>alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."));
}

/* ===========================
   Export ê´€ë ¨
   =========================== */
function collectCleanClips(targetClips) {
  refreshClipTimes();
  return targetClips.map(c => ({
    start: c.start,
    end: c.end
  }));
}

function startExport(cleanClips) {
  if (!cleanClips.length) {
    alert("êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤!");
    return;
  }

  const container = document.getElementById("exportProgressContainer");
  const bar = document.getElementById("exportProgressBar");
  const statusText = document.getElementById("exportStatusText");
  const stopBtn = document.getElementById("exportStopBtn");

  container.style.display = "block";
  bar.value = 0;
  statusText.textContent = "";
  stopBtn.disabled = false;
  document.body.style.cursor = "wait";

  fetch("/export", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({
      video: videoName,
      clips: cleanClips
    })
  })
  .then(r => r.json())
  .then(data => {
    document.body.style.cursor = "default";
    if (!data.job_id) {
      alert("í•˜ì´ë¼ì´íŠ¸ ìƒì„± ì‹œì‘ ì‹¤íŒ¨: " + (data.error || "ì˜¤ë¥˜"));
      return;
    }
    currentJobId = data.job_id;
    window._export_result_file = data.file;
    exportPolling = true;
    pollExport();
  })
  .catch(err => {
    document.body.style.cursor = "default";
    alert("ìš”ì²­ ì‹¤íŒ¨: " + err);
  });
}

function pollExport() {
  if (!currentJobId) return;
  fetch("/export_progress?job_id=" + encodeURIComponent(currentJobId))
    .then(r => r.json())
    .then(data => {
      const bar = document.getElementById("exportProgressBar");
      const statusText = document.getElementById("exportStatusText");
      const p = data.progress || 0;
      bar.value = p;
      statusText.textContent = (data.status || "") + " (" + p + "%)";

      if (data.status === "done") {
        exportPolling = false;
        const url = window._export_result_file;
        currentJobId = null;
        window.location.href = url;
      } else if (data.status === "error" || data.status === "stopped") {
        exportPolling = false;
        currentJobId = null;
        alert("í•˜ì´ë¼ì´íŠ¸ ìƒì„± ì‹¤íŒ¨ / ì¤‘ì§€: " + (data.error || data.status));
      } else if (exportPolling) {
        setTimeout(pollExport, 1000);
      }
    })
    .catch(() => {
      if (exportPolling) setTimeout(pollExport, 1500);
    });
}

function stopExport() {
  if (!currentJobId) return;
  document.getElementById("exportStopBtn").disabled = true;
  fetch("/export_stop", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ job_id: currentJobId })
  });
}

function downloadHighlight() {
  if (!clips.length) {
    alert("êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤!");
    return;
  }
  startExport(collectCleanClips(clips));
}

function downloadColorHighlight(color) {
  const target = clips.filter(c => c.color === color);
  if (!target.length) {
    alert(color === "red" ? "ë¹¨ê°„ êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤." : "íŒŒë€ êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  startExport(collectCleanClips(target));
}

function downloadPlayerHighlight() {
  const markerSelect = document.getElementById("markerSelect");
  const marker = markerSelect.value;
if (!marker) {
alert("ë§ˆí‚¹ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
return;
}
const target = clips.filter(c => c.label === marker);
if (!target.length) {
alert("í•´ë‹¹ ë²ˆí˜¸ì˜ êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤.");
return;
}
startExport(collectCleanClips(target));
}
function startHighlightLoop() {
cancelAnimationFrame(rafId);
function loop() {
if (!playingHighlights) return;
const cur = highlightQueue[currentIndex];
if (videoEl.currentTime >= cur.end - 0.05) {
currentIndex++;
if (currentIndex >= highlightQueue.length) {
playingHighlights = false;
videoEl.pause();
return;
}
const next = highlightQueue[currentIndex];
videoEl.currentTime = next.start;
videoEl.play();
}
rafId = requestAnimationFrame(loop);
}
rafId = requestAnimationFrame(loop);
}
function playHighlights() {
refreshClipTimes();
if (selectedClips.size > 0) {
highlightQueue = Array.from(selectedClips).sort((a,b)=>a.start - b.start);
} else {
highlightQueue = clips.slice().sort((a,b)=>a.start - b.start);
}
if (!highlightQueue.length) {
alert("í•˜ì´ë¼ì´íŠ¸ êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤.");
return;
}
currentIndex = 0;
playingHighlights = true;
videoEl.currentTime = highlightQueue[0].start;
videoEl.play();
startHighlightLoop();
}
document.addEventListener("keydown", e => {
const tag = (e.target.tagName || "").toUpperCase();
if (tag === "INPUT" || tag === "SELECT" || e.target.isContentEditable) return;
if (e.key === "Delete" || e.key === "Backspace") {
deleteClip();
} else if (e.key >= "0" && e.key <= "9") {
handleDigitKey(e.key);
}
});
</script>
</body>
</html>
````