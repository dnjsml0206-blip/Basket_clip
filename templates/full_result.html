<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ¬ êµì°¨ í¸ì§‘ ê²°ê³¼</title>

    <style>
        body {
            background: #121212;
            color: #fff;
            font-family: sans-serif;
            padding: 24px;
        }

        h2 { margin-top: 0; }

        /* --------- ë©”ì¸ í”„ë¦¬ë·° ì˜ì—­ --------- */
        #previewCanvas {
            width: 100%;
            max-height: 440px;
            background: #000;
            border-radius: 8px;
        }

        .control-bar {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #playPauseBtn, #playCrossBtn {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            background: #0af;
            color: #000;
            font-size: 14px;
        }

        #playCrossBtn {
            background: #ff0;
            font-weight: bold;
        }

        #timeLabel {
            font-size: 13px;
            color: #ccc;
            min-width: 90px;
        }

        #seekSlider {
            flex: 1;
        }

        /* --------- íƒ€ì„ë¼ì¸ + Ruler ìŠ¤í¬ë¡¤ ì˜ì—­ --------- */
        #timelineWrapper {
            margin-top: 20px;
            width: 100%;
            overflow-x: auto;   /* ğŸ”¥ ì¢Œìš° ìŠ¤í¬ë¡¤ */
            overflow-y: hidden;
            padding-bottom: 8px;
        }

        .timeline-inner {
            width: 3000px;      /* ìŠ¤í¬ë¡¤ ìƒê¸°ë„ë¡ ê°€ë¡œë¡œ ê¸¸ê²Œ */
        }

        .timeline-box {
            margin-top: 10px;
        }

        .timeline-label {
            font-size: 13px;
            margin-bottom: 4px;
            color: #ccc;
        }

        .timeline {
            height: 20px;
            background: #666;
            margin-top: 4px;
            position: relative;
            border-radius: 4px;
            cursor: pointer;
        }

        .selection-box {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(0,150,255,0.25);
            border: 1px solid #09f;
            pointer-events: none;
        }

        .segment {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(0, 200, 255, 0.4);
            border: 1px solid #00e1ff;
            box-sizing: border-box;
        }

        /* --------- Ruler (íƒ€ì„ë¼ì¸ê³¼ í•¨ê»˜ ìŠ¤í¬ë¡¤) --------- */
        .ruler {
            margin-top: 10px;
            height: 20px;
            position: relative;
            font-size: 10px;
            color: #aaa;
        }

        .tick {
            position: absolute;
            top: 0;
            height: 8px;
            width: 1px;
            background: #aaa;
        }

        .tick-label {
            position: absolute;
            top: 10px;
            font-size: 10px;
            transform: translateX(-50%);
        }

        /* --------- í•˜ë‹¨ ë²„íŠ¼ --------- */
        .btn-row {
            margin-top: 24px;
        }

        .btn-nav {
            padding: 8px 16px;
            margin-right: 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-main {
            background: #0af;
            color: #000;
            font-weight: bold;
        }

        .btn-sec {
            background: #444;
            color: #fff;
        }

        .info-box {
            margin-top: 16px;
            font-size: 13px;
            color: #aaa;
            line-height: 1.5;
        }
    </style>
</head>

<body>

<h2>ğŸ‰ êµì°¨ í¸ì§‘ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h2>

<!-- ì‹¤ì œ ì¬ìƒ ì†ŒìŠ¤ (ì¢Œ/ìš°, ì˜¤ë””ì˜¤ëŠ” left ì‚¬ìš©) -->
<video id="leftVideo"  src="/full_file?p={{ left_src }}"  style="display:none"></video>
<video id="rightVideo" src="/full_file?p={{ right_src }}" muted style="display:none"></video>

<!-- ë‘ ì˜ìƒì„ ê²¹ì³ì„œ ë³´ì—¬ì¤„ Canvas (1ê°œë§Œ ì‚¬ìš©) -->
<canvas id="previewCanvas" width="1280" height="720"></canvas>

<!-- ì¬ìƒ ì»¨íŠ¸ë¡¤ + êµì°¨ ì¬ìƒ -->
<div class="control-bar">
    <button id="playPauseBtn">â–¶ ì¬ìƒ</button>
    <button id="playCrossBtn">â¯ êµì°¨ ì¬ìƒ</button>
    <span id="timeLabel">00:00 / 00:00</span>
    <input type="range" id="seekSlider" min="0" max="1000" value="0">
</div>

<!-- íƒ€ì„ë¼ì¸ + Ruler (ëª¨ë‘ í•˜ë‚˜ì˜ ìŠ¤í¬ë¡¤ ì˜ì—­ ì•ˆì—) -->
<div id="timelineWrapper">
    <div class="timeline-inner">
        <div class="timeline-box">
            <div class="timeline-label">ì¢Œì¸¡ ì¹´ë©”ë¼</div>
            <div id="timelineLeft" class="timeline"></div>
        </div>

        <div class="timeline-box">
            <div class="timeline-label">ìš°ì¸¡ ì¹´ë©”ë¼</div>
            <div id="timelineRight" class="timeline"></div>
        </div>

        <!-- ê³µí†µ Ruler (íƒ€ì„ë¼ì¸ë“¤ê³¼ ê°™ì´ ìŠ¤í¬ë¡¤) -->
        <div id="ruler" class="ruler"></div>
    </div>
</div>

<div class="btn-row">
    <button class="btn-nav btn-main" onclick="location.href='/full_select'">ë‹¤ë¥¸ ì˜ìƒ í¸ì§‘í•˜ê¸°</button>
    <button class="btn-nav btn-sec" onclick="location.href='/'">í™ˆìœ¼ë¡œ ì´ë™</button>
</div>

<div class="info-box">
    â€¢ ìœ„ ìº”ë²„ìŠ¤ëŠ” ì¢Œ/ìš° ì¹´ë©”ë¼ ì˜ìƒì„ <b>ì‹±í¬ ë§ì¶˜ ìƒíƒœ</b>ë¡œ í•˜ë‚˜ì˜ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.<br>
    â€¢ ì•„ë˜ íšŒìƒ‰ ë§‰ëŒ€ëŠ” ì¢Œ/ìš° ê°ê°ì˜ ì´¬ì˜ êµ¬ê°„ì´ë©°, ìƒ‰ ë§‰ëŒ€ëŠ” <b>êµì°¨ í¸ì§‘ì—ì„œ ì‚¬ìš©ëœ êµ¬ê°„</b>ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.<br>
    â€¢ íƒ€ì„ë¼ì¸ ë¹ˆ ê³³ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì‹œì ìœ¼ë¡œ ì´ë™í•˜ê³ , êµì°¨ ì¬ìƒì„ ëˆ„ë¥´ë©´ ì „ì²´ êµ¬ê°„ì„ ìë™ ì „í™˜í•˜ë©° ì¬ìƒí•©ë‹ˆë‹¤.
</div>

<script>
/* ======================= í…œí”Œë¦¿ ë°ì´í„° ======================= */
const sessionId      = "{{ session_id }}";
const duration       = Number({{ duration }});   // ì „ì²´ ê¸¸ì´(ì´ˆ)
const leftSrcPath    = "{{ left_src }}";
const rightSrcPath   = "{{ right_src }}";
const leftVideoName  = "{{ left_video }}";
const rightVideoName = "{{ right_video }}";
const offset         = Number({{ offset|default(0) }});  // í•„ìš” ì‹œ ì‚¬ìš© (í˜„ì¬ëŠ” ì˜ë¦° ì˜ìƒ ê¸°ì¤€ì´ë¼ 0ì´ì–´ì•¼ ì •ìƒ)

/* ì¢Œ/ìš° êµì°¨ ì„¸ê·¸ë¨¼íŠ¸ (ë¹ˆ ì‹œê°„ëŒ€ ì—†ì´ ì „ì²´ ë®ëŠ” í˜•íƒœ) */
let leftClips  = {{ left_clips  | tojson }};
let rightClips = {{ right_clips | tojson }};

/* ë‚´ë¶€ segments: { start, end, side } */
let segments = [];
leftClips.forEach(c  => segments.push({ start: c.start, end: c.end, side: "left"  }));
rightClips.forEach(c => segments.push({ start: c.start, end: c.end, side: "right" }));
// ì‹œê°„ìˆœ ì •ë ¬ ë³´ì¥
segments.sort((a,b) => a.start - b.start);

let currentTime = 0;
let playing = false;
let crossPlaying = false;

/* ì¬ìƒ ê´€ë ¨ DOM */
const leftVideo  = document.getElementById("leftVideo");
const rightVideo = document.getElementById("rightVideo");
const canvas     = document.getElementById("previewCanvas");
const ctx        = canvas.getContext("2d");

const tlLeft  = document.getElementById("timelineLeft");
const tlRight = document.getElementById("timelineRight");
const ruler   = document.getElementById("ruler");
const playBtn = document.getElementById("playPauseBtn");
const crossBtn = document.getElementById("playCrossBtn");
const seek    = document.getElementById("seekSlider");
const timeLbl = document.getElementById("timeLabel");


/* ======================= 1) ì‹œê°„ í¬ë§· & UI ======================= */
function formatTime(sec) {
    if (!isFinite(sec)) sec = 0;
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
}

function updateSeekUI() {
    if (!duration || !isFinite(duration) || duration <= 0) {
        seek.value = 0;
        timeLbl.textContent = "00:00 / 00:00";
        return;
    }
    const ratio = currentTime / duration;
    seek.value = Math.max(0, Math.min(1000, Math.floor(ratio * 1000)));
    timeLbl.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
}

function updatePlayButton() {
    playBtn.textContent  = playing ? "â¸ ì¼ì‹œì •ì§€" : "â–¶ ì¬ìƒ";
    crossBtn.textContent = crossPlaying ? "â–  êµì°¨ ì¬ìƒ ì¤‘ì§€" : "â¯ êµì°¨ ì¬ìƒ";
}


/* ======================= 2) ì‹±í¬ ë§ì¶° ë¹„ë””ì˜¤ ìœ„ì¹˜ì‹œí‚¤ê¸° ======================= */
function syncVideosToCurrentTime() {
    // ê¸°ì¤€: leftTime = currentTime
    leftVideo.currentTime = currentTime;

    // offset ì„ ê³ ë ¤í•œ rightTime (í˜„ì¬ offset=0ì´ ì •ìƒ)
    let rt = currentTime - offset;
    if (rt < 0) rt = 0;
    if (rightVideo.duration && rt > rightVideo.duration) rt = rightVideo.duration;
    rightVideo.currentTime = rt;
}


/* ======================= 3) ì–´ë–¤ ì¹´ë©”ë¼ë¥¼ ë³´ì—¬ì¤„ì§€ ê²°ì • ======================= */
function getCameraForTime(t) {
    // segments ì „ì²´ë¥¼ ìˆœíšŒí•´ì„œ í•´ë‹¹ ì‹œê°„ì— í¬í•¨ë˜ëŠ” ë§ˆì§€ë§‰ segment ì„ íƒ
    let cam = "left";
    for (const seg of segments) {
        if (t >= seg.start && t < seg.end) {
            cam = seg.side;
        }
    }
    return cam;
}


/* ======================= 4) Ruler & íƒ€ì„ë¼ì¸ ë Œë” ======================= */
function buildRuler() {
    ruler.innerHTML = "";
    if (!duration || !isFinite(duration) || duration <= 0) return;

    const step = duration <= 60 ? 5 : 10;
    for (let t = 0; t <= duration; t += step) {
        const xRatio = t / duration;
        const xPercent = xRatio * 100;

        const tick = document.createElement("div");
        tick.className = "tick";
        tick.style.left = xPercent + "%";
        ruler.appendChild(tick);

        const label = document.createElement("div");
        label.className = "tick-label";
        label.style.left = xPercent + "%";
        label.innerText = `${t}s`;
        ruler.appendChild(label);
    }
}

function renderTimeline() {
    tlLeft.innerHTML  = "";
    tlRight.innerHTML = "";

    const pxLeft  = tlLeft.clientWidth  || 1;
    const pxRight = tlRight.clientWidth || 1;

    segments.forEach(seg => {
        const tl      = seg.side === "left" ? tlLeft : tlRight;
        const tlWidth = seg.side === "left" ? pxLeft : pxRight;

        const box = document.createElement("div");
        box.className = "segment";

        const left = (seg.start / duration) * 100;
        const width = ((seg.end - seg.start) / duration) * 100;
        box.style.left  = left + "%";
        box.style.width = width + "%";

        // í´ë¦­ â†’ í•´ë‹¹ ì‹œì ìœ¼ë¡œ ì í”„ (ììœ  ì¬ìƒ)
        box.addEventListener("click", (e) => {
            e.stopPropagation();
            currentTime = seg.start;
            syncVideosToCurrentTime();
            updateSeekUI();
        });

        tl.appendChild(box);
    });
}


/* ======================= 5) íƒ€ì„ë¼ì¸ ë¹ˆ ê³µê°„ í´ë¦­ â†’ ì‹œì  ì´ë™ ======================= */
function attachTimelineClick() {
    function bind(timelineElem) {
        timelineElem.addEventListener("click", (e) => {
            if (e.target.classList.contains("segment")) return;

            const rect  = timelineElem.getBoundingClientRect();
            const ratio = (e.clientX - rect.left) / rect.width;
            let t = ratio * duration;
            t = Math.max(0, Math.min(duration, t));

            currentTime = t;
            syncVideosToCurrentTime();
            updateSeekUI();
        });
    }
    bind(tlLeft);
    bind(tlRight);
}


/* ======================= 6) ì¬ìƒ/êµì°¨ ì¬ìƒ ======================= */
function playVideos() {
    leftVideo.play().catch(()=>{});
    rightVideo.play().catch(()=>{});
}

function pauseVideos() {
    leftVideo.pause();
    rightVideo.pause();
}

function togglePlay() {
    if (!duration || duration <= 0) return;

    if (playing) {
        playing = false;
        pauseVideos();
    } else {
        playing = true;
        crossPlaying = false; // ê°œë³„ ì¬ìƒ ì‹œì‘ ì‹œ êµì°¨ ì¬ìƒ í”Œë˜ê·¸ í•´ì œ
        syncVideosToCurrentTime();
        playVideos();
    }
    updatePlayButton();
}

function startCrossPlay() {
    if (!duration || duration <= 0) {
        alert("ì¬ìƒí•  ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    // ì²˜ìŒë¶€í„° ì „ì²´ êµì°¨ ì¬ìƒ
    currentTime = 0;
    syncVideosToCurrentTime();
    playing = true;
    crossPlaying = true;
    playVideos();
    updatePlayButton();
}

function stopCrossPlay() {
    crossPlaying = false;
    playing = false;
    pauseVideos();
    updatePlayButton();
}


/* ======================= 7) Seek ë°” ======================= */
seek.addEventListener("input", (e) => {
    const val   = Number(e.target.value);
    const ratio = val / 1000;
    currentTime = duration * ratio;
    syncVideosToCurrentTime();
    updateSeekUI();
});

seek.addEventListener("change", () => {
    if (!playing) pauseVideos();
});


/* ======================= 8) Canvas ë Œë” ë£¨í”„ ======================= */
function drawFrame(cam) {
    const w = canvas.width;
    const h = canvas.height;
    ctx.clearRect(0, 0, w, h);

    try {
        // ê¸°ë³¸ì€ left ë¨¼ì €
        ctx.drawImage(leftVideo, 0, 0, w, h);
    } catch(e) {}

    if (cam === "right") {
        try {
            ctx.drawImage(rightVideo, 0, 0, w, h);
        } catch(e) {}
    }
}

function startRenderLoop() {
    function loop() {
        if (playing) {
            // left ë¥¼ ê¸°ì¤€ íƒ€ì„ë¼ì¸ìœ¼ë¡œ ì‚¬ìš©
            currentTime = leftVideo.currentTime;
            if (currentTime >= duration) {
                currentTime = duration;
                playing = false;
                crossPlaying = false;
                pauseVideos();
                updatePlayButton();
            } else {
                // right ëŠ” offset ë°˜ì˜í•´ì„œ ë”°ë¼ê°€ê²Œ
                let rt = currentTime - offset;
                if (rt < 0) rt = 0;
                if (rightVideo.duration && rt > rightVideo.duration) rt = rightVideo.duration;
                rightVideo.currentTime = rt;
            }
        }

        const cam = getCameraForTime(currentTime);
        drawFrame(cam);
        updateSeekUI();

        requestAnimationFrame(loop);
    }
    loop();
}


/* ======================= 9) ì´ˆê¸°í™” ======================= */
buildRuler();
renderTimeline();
attachTimelineClick();
updateSeekUI();
updatePlayButton();

playBtn.onclick  = togglePlay;
crossBtn.onclick = () => {
    if (crossPlaying) {
        stopCrossPlay();
    } else {
        startCrossPlay();
    }
};

// ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë”© ì™„ë£Œ í›„ ë Œë” ë£¨í”„ ì‹œì‘
let metaLoaded = 0;
function onMetaLoaded() {
    metaLoaded++;
    if (metaLoaded >= 2) {
        currentTime = 0;
        syncVideosToCurrentTime();
        updateSeekUI();
        startRenderLoop();
    }
}
leftVideo.addEventListener("loadedmetadata", onMetaLoaded);
rightVideo.addEventListener("loadedmetadata", onMetaLoaded);

</script>

</body>
</html>
