<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ì‹±í¬ ì¡°ì •</title>

<style>
body { background:#111; color:#fff; font-family:sans-serif; padding:20px; }

.flex-row { display:flex; gap:20px; margin-bottom:20px; }
.video-box { flex:1; }
video { width:100%; border-radius:8px; background:black; }

/* wave layout */
.wave-row { display:flex; gap:20px; margin-top:15px; }
.wave-box { flex:1; position:relative; }
canvas { width:100%; height:120px; background:#222; border-radius:4px; cursor:pointer; }

.sync-marker {
    pointer-events:none;
}
.time-label {
    pointer-events:none;
}


/* playheads */
.playhead {
    position:absolute;
    top:0;
    width:2px;
    background:#0af;
    height:100%;
}

.sync-marker {
    position:absolute;
    top:0;
    width:2px;
    background:#f33;
    height:100%;
}

.time-label {
    position:absolute;
    top:0;
    transform:translate(-50%, -20px);
    font-size:12px;
    background:#0008;
    padding:2px 5px;
    border-radius:3px;
}

/* info */
.info-area { margin-top:15px; font-size:14px; color:#ddd; }
button { padding:10px 18px; margin-top:25px; background:#0af; border:none; border-radius:6px; cursor:pointer; }
</style>
</head>

<body>

<h2>ğŸ¬ ì‹±í¬ ì¡°ì • â€” ì• 30ì´ˆ ê¸°ì¤€</h2>
<p>ì¶”ì²œ ì‹±í¬ ì˜¤í”„ì…‹: <b id="autoLabel">{{ auto_offset }}</b>ì´ˆ</p>

<!-- ì˜ìƒ 2ê°œ ë³‘ë ¬ -->
<div class="flex-row">
    <div class="video-box">
        <label>Left Video (0â€“30ì´ˆ)</label>
        <video id="leftVideo" src="/full_video?video={{ left_video }}" controls></video>
    </div>

    <div class="video-box">
        <label>Right Video (0â€“30ì´ˆ)</label>
        <video id="rightVideo" src="/full_video?video={{ right_video }}" controls></video>
    </div>
</div>

<!-- íŒŒí˜• -->
<div class="wave-row">
    <div class="wave-box">
        <img id="waveL" src="{{ left_wave }}" style="width:100%; height:120px; object-fit:cover;">
        <div id="leftHead" class="playhead"></div>
        <div id="syncL" class="sync-marker"></div>
        <div id="syncLLabel" class="time-label"></div>
    </div>

    <div class="wave-box">
        <img id="waveR" src="{{ right_wave }}" style="width:100%; height:120px; object-fit:cover;">
        <div id="rightHead" class="playhead"></div>
        <div id="syncR" class="sync-marker"></div>
        <div id="syncRLabel" class="time-label"></div>
    </div>

</div>

<div class="info-area">
    <div>Left Time: <span id="leftTimeTxt">0.00</span>ì´ˆ (frame <span id="leftFrameTxt">0</span>)</div>
    <div>Right Time: <span id="rightTimeTxt">0.00</span>ì´ˆ (frame <span id="rightFrameTxt">0</span>)</div>
</div>

<button onclick="confirmSync()">ğŸ¯ ì‹±í¬ í™•ì •í•˜ê¸°</button>

<script>
/* -------------------------
    ì´ˆê¸°ê°’
--------------------------*/
const maxSec = 30.0;
const fps = 30;  // ì˜ìƒ fps (í•„ìš” ì‹œ ì„œë²„ì—ì„œ ë„˜ê²¨ì¤„ ìˆ˜ ìˆìŒ)
let leftTime = 0;
let rightTime = parseFloat("{{ auto_offset }}");

const autoOffset = parseFloat("{{ auto_offset }}");

/* -------------------------
    DOM
--------------------------*/
const leftVideo = document.getElementById("leftVideo");
const rightVideo = document.getElementById("rightVideo");

const waveL = document.getElementById("waveL");
const waveR = document.getElementById("waveR");

const leftHead  = document.getElementById("leftHead");
const rightHead = document.getElementById("rightHead");

const syncL     = document.getElementById("syncL");
const syncR     = document.getElementById("syncR");
const syncLLabel = document.getElementById("syncLLabel");
const syncRLabel = document.getElementById("syncRLabel");

const leftTimeTxt  = document.getElementById("leftTimeTxt");
const rightTimeTxt = document.getElementById("rightTimeTxt");
const leftFrameTxt  = document.getElementById("leftFrameTxt");
const rightFrameTxt = document.getElementById("rightFrameTxt");

/* -------------------------
    ì¶”ì²œ offset ë¹¨ê°„ë§‰ëŒ€ ìœ„ì¹˜
--------------------------*/
function placeSyncMarkers() {
    const posL = (autoOffset / maxSec) * waveL.clientWidth;
    const posR = (autoOffset / maxSec) * waveR.clientWidth;

    syncL.style.left = posL + "px";
    syncR.style.left = posR + "px";

    syncLLabel.style.left = posL + "px";
    syncRLabel.style.left = posR + "px";

    syncLLabel.textContent = `${autoOffset.toFixed(2)}s`;
    syncRLabel.textContent = `${autoOffset.toFixed(2)}s`;
}

/* -------------------------
    ì˜ìƒ ì¬ìƒ 30ì´ˆ ì œí•œ
--------------------------*/
leftVideo.addEventListener("timeupdate", () => {
    if (leftVideo.currentTime > maxSec) leftVideo.currentTime = maxSec;
    leftTime = leftVideo.currentTime;
    updateInfo();
});

rightVideo.addEventListener("timeupdate", () => {
    if (rightVideo.currentTime > maxSec) rightVideo.currentTime = maxSec;
    rightTime = rightVideo.currentTime;
    updateInfo();
});

/* -------------------------
    playhead ìœ„ì¹˜ í‘œì‹œ
--------------------------*/
function updatePlayheads() {
    leftHead.style.left  = (leftTime  / maxSec) * waveL.clientWidth + "px";
    rightHead.style.left = (rightTime / maxSec) * waveR.clientWidth + "px";
}

function updateInfo() {
    leftTimeTxt.textContent  = leftTime.toFixed(2);
    rightTimeTxt.textContent = rightTime.toFixed(2);

    leftFrameTxt.textContent  = Math.round(leftTime * fps);
    rightFrameTxt.textContent = Math.round(rightTime * fps);

    updatePlayheads();
}

/* -------------------------
    íŒŒí˜• í´ë¦­ â†’ í•´ë‹¹ ì‹œì  ì´ë™
--------------------------*/
function bindWaveClick(canvas, isLeft) {
    canvas.addEventListener("click", (e) => {
        const rect = canvas.getBoundingClientRect();
        let x = e.clientX - rect.left;
        let sec = (x / canvas.clientWidth) * maxSec;
        sec = Math.max(0, Math.min(maxSec, sec));

        if (isLeft) {
            leftTime = sec;
            leftVideo.currentTime = sec;
        } else {
            rightTime = sec;
            rightVideo.currentTime = sec;
        }

        updateInfo();
    });
}
bindWaveClick(waveL, true);
bindWaveClick(waveR, false);

/* -------------------------
    í‚¤ë³´ë“œë¡œ í”„ë ˆì„ ë‹¨ìœ„ ì´ë™
--------------------------*/
document.addEventListener("keydown", (e) => {
    let step = 1 / fps;

    if (e.key === "ArrowLeft") {
        leftTime -= step;
        rightTime -= step;
    }
    if (e.key === "ArrowRight") {
        leftTime += step;
        rightTime += step;
    }

    leftTime = Math.max(0, Math.min(maxSec, leftTime));
    rightTime = Math.max(0, Math.min(maxSec, rightTime));

    leftVideo.currentTime = leftTime;
    rightVideo.currentTime = rightTime;
    updateInfo();

});

/* -------------------------
    ì‹±í¬ í™•ì •
--------------------------*/
async function confirmSync() {
    const offset = (rightTime - leftTime).toFixed(2);

    const res = await fetch("/full_sync_confirm", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
            left:"{{ left_video }}",
            right:"{{ right_video }}",
            offset: offset
        })
    });

    const data = await res.json();
    if (!data.ok) { alert("ì‹±í¬ ì €ì¥ ì‹¤íŒ¨"); return; }

    window.location.href =
        `/full?left={{ left_video }}&right={{ right_video }}&session=${Date.now()}`;
}

/* -------------------------
    ì´ˆê¸° ì‹¤í–‰
--------------------------*/
placeSyncMarkers();
updateInfo();
</script>

</body>
</html>
