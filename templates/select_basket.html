<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>골대 위치 선택</title>
    <style>
        body {
            background:#101820;
            color:#fff;
            text-align:center;
            font-family:sans-serif;
            padding:20px;
        }
        canvas {
            border:2px solid #fff;
            cursor:crosshair;
            margin-top:20px;
        }
        button {
            margin-top:20px;
            padding:10px 20px;
            border-radius:6px;
            border:none;
            background:#222;
            color:#fff;
            cursor:pointer;
        }
        button:hover {
            background:#444;
        }
        a { color:#0ff; }
    </style>
</head>

<body>
    <h1>골대 위치를 드래그해서 선택하세요</h1>
    <p>중간 프레임에서 림(골대)을 드래그로 지정하면 자동으로 좌표가 저장됩니다.</p>

    <canvas id="canvas"></canvas><br>
    <button id="saveBtn">좌표 저장</button>

    <p id="msg"></p>

    <div style="margin-top:20px;">
        <a href="/">⬅ 분석 화면으로 돌아가기</a>
    </div>

    <script>
        // URL로 전달된 다음 작업할 영상 리스트
        const url = new URL(window.location.href);
        const NEXT_LIST = JSON.parse(url.searchParams.get("next") || "[]");
        const img = new Image();
        img.src = "/static/frames/{{ frame_file }}";

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // 원본 해상도 (백엔드에서 전달)
        const origW = Number("{{ orig_w }}");
        const origH = Number("{{ orig_h }}");

        let rect = null, drawing = false, sx = 0, sy = 0;

        // 이미지 로딩 후 Canvas에 맞게 그리기
        img.onload = () => {
            const maxW = 800;
            const ratio = img.width / img.height;

            canvas.width = maxW;
            canvas.height = maxW / ratio;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };

        // 드래그 시작
        canvas.addEventListener('mousedown', e => {
            const r = canvas.getBoundingClientRect();
            sx = e.clientX - r.left;
            sy = e.clientY - r.top;

            rect = { x1: sx, y1: sy, x2: sx, y2: sy };
            drawing = true;
        });

        // 드래그 중
        canvas.addEventListener('mousemove', e => {
            if (!drawing) return;

            const r = canvas.getBoundingClientRect();
            rect.x2 = e.clientX - r.left;
            rect.y2 = e.clientY - r.top;

            // 프레임 다시 그림 + 박스 표시
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "red";
            ctx.lineWidth = 2;
            ctx.strokeRect(rect.x1, rect.y1, rect.x2 - rect.x1, rect.y2 - rect.y1);
        });

        // 드래그 종료
        canvas.addEventListener('mouseup', () => drawing = false);

        // 좌표 저장
        document.getElementById('saveBtn').onclick = async () => {
            if (!rect) return alert("먼저 골대를 드래그하세요!");

            // Canvas 좌표 → 원본 좌표 환산
            const scaleX = origW / canvas.width;
            const scaleY = origH / canvas.height;

            const x1 = Math.min(rect.x1, rect.x2) * scaleX;
            const y1 = Math.min(rect.y1, rect.y2) * scaleY;
            const x2 = Math.max(rect.x1, rect.x2) * scaleX;
            const y2 = Math.max(rect.y1, rect.y2) * scaleY;

            const res = await fetch("/save_basket", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    video: "{{ video }}",
                    x1: Math.round(x1),
                    y1: Math.round(y1),
                    x2: Math.round(x2),
                    y2: Math.round(y2),
                    next: NEXT_LIST 
                })
            });

            const data = await res.json();
            if (data.next) {
                // 다음 영상으로 자동 이동
                window.location.href =
                    "/select_basket?video=" + encodeURIComponent(data.next) +
                    "&next=" + encodeURIComponent(JSON.stringify(data.remain));
                return;
            }

            if (data.ok) {
                document.getElementById("msg").innerText =
                    "좌표 저장 완료! 모든 영상 설정을 끝냈습니다. 분석 화면으로 돌아가세요.";
                return;
            }

            else {
                document.getElementById("msg").innerText =
                    "저장 실패: " + (data.error || "알 수 없는 오류");
            }
        };
    </script>
</body>
</html>
