<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>YOLO í•˜ì´ë¼ì´íŠ¸ ë¶„ì„ê¸°</title>
    <style>
    body { background:#111; color:white; font-family:sans-serif; text-align:center; margin-top:40px; }
    select,button { padding:10px; margin:10px; border-radius:6px; }
    progress { width:80%; height:30px; margin-top:10px; }
    #status { margin-top:10px; font-size:18px; }
    </style>
</head>
<body>
    <h2>ğŸ€ YOLO í•˜ì´ë¼ì´íŠ¸ ë¶„ì„ê¸°</h2>

    <!-- ğŸ”¥ ì˜ìƒ ì—…ë¡œë“œ ê¸°ëŠ¥ -->
    <h3>ğŸ“¤ ì˜ìƒ ì—…ë¡œë“œ</h3>

    <input type="file" id="uploadFile" accept="video/*" multiple>
    <button onclick="uploadVideos()">ì˜ìƒ ì—…ë¡œë“œ</button>

    <div id="uploadStatus" style="margin-top:10px; color:#0f0;"></div>
    <hr style="width:60%; margin:20px auto;">


    <!-- â˜… ì´ë¯¸ multiple ì ìš© â†’ ìœ ì§€ -->
    <select id="video" name="video" multiple size="6">
        {% for v in videos %}
        <option value="{{v}}">{{v}}</option>
        {% endfor %}
    </select><br>

    <button onclick="selectBasket()">ê³¨ëŒ€ ì¢Œí‘œ ì„ íƒ</button>
    <button onclick="start()">ë¶„ì„ ì‹œì‘</button>
    <button id="stopBtn" onclick="stopProcess()" disabled>ì¤‘ì§€</button>
    <button onclick="goCrossEdit()">ì¢Œ/ìš° ê³¨ëŒ€ êµì°¨ í¸ì§‘</button>

    <div id="status">ëŒ€ê¸° ì¤‘...</div>
    <progress id="bar" value="0" max="100"></progress>

    <h3 style="margin-top:40px;">ğŸ“ ì €ì¥ëœ ë¶„ì„</h3>
    <div id="savedList"></div>

<script>
/* ------------------------------
   ì €ì¥ëœ ë¶„ì„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
------------------------------ */
fetch("/saved")
.then(r => r.json())
.then(list => {
    const box = document.getElementById("savedList");
    box.innerHTML = "";

    list.forEach(item => {
        const cleanName = item.video.replace(/\.[^/.]+$/, "");
        const div = document.createElement("div");
        div.style.margin = "6px";

        div.innerHTML = `
            <a href="/result_page?video=${encodeURIComponent(item.video)}&clips=${encodeURIComponent(JSON.stringify(item.clips || []))}"
                style="color:#0ff; text-decoration:none;">
                <b>${cleanName}</b>
            </a>
            (${item.created})
            <button onclick="delSaved('${item.id}')">ì‚­ì œ</button>
        `;

        box.appendChild(div);
    });
});

function delSaved(id) {
    fetch("/saved/" + id, { method: "DELETE" })
        .then(() => location.reload());
}

/* ------------------------------
   ê³¨ëŒ€ ì¢Œí‘œ ì„ íƒ
------------------------------ */
async function selectBasket() {
    const video = document.getElementById('video').value;
    if (!video) {
        alert("ì˜ìƒì„ ì„ íƒí•˜ì„¸ìš”!");
        return;
    }
    window.location.href = '/select_basket?video=' + encodeURIComponent(video);
}

/* ============================================
   ğŸ”¥ğŸ”¥ ë‹¤ì¤‘ ì˜ìƒ ë¶„ì„ í•µì‹¬ start() ì¬ì‘ì„±
============================================ */
async function start() {
    const sel = document.getElementById("video");
    const selected = [...sel.options].filter(o => o.selected).map(o => o.value);

    if (selected.length === 0) {
        alert("ì˜ìƒì„ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”!");
        return;
    }

    // ì¢Œí‘œ ì²´í¬
    let missing = [];
    let needReset = [];

    for (const v of selected) {
        const coords = await fetch('/basket_coords?video=' + encodeURIComponent(v))
                            .then(r => r.json())
                            .catch(() => null);

        if (!coords || !coords.x1) {
            missing.push(v);
            continue;
        }

        const reset = confirm(`${v} ì˜ìƒì€ ê¸°ì¡´ ê³¨ëŒ€ ì¢Œí‘œê°€ ìˆìŠµë‹ˆë‹¤.\nì¬ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
        if (reset) needReset.push(v);
    }

    // ì¬ì„¤ì • í•„ìš”í•œ ì˜ìƒ
    if (needReset.length > 0) {
        const v = needReset[0];
        window.location.href =
            "/select_basket?video=" + encodeURIComponent(v) +
            "&next=" + encodeURIComponent(JSON.stringify(needReset.slice(1).concat(missing)));
        return;
    }

    // ì¢Œí‘œ ì—†ëŠ” ì˜ìƒ ì²˜ë¦¬
    if (missing.length > 0) {
        if (missing.length === 1) {
            const ok = confirm(`ë‹¤ìŒ ì˜ìƒì˜ ê³¨ëŒ€ ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤:\n${missing[0]}\nì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!ok) return;

            window.location.href =
                "/select_basket?video=" + encodeURIComponent(missing[0]);
            return;
        }

        const first = missing[0];
        const queue = missing.slice(1);
        alert(`ë‹¤ìŒ ì˜ìƒë“¤ì— ê³¨ëŒ€ ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤.\nìˆœì„œëŒ€ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.\n1: ${first}`);

        window.location.href =
            "/select_basket?video=" + encodeURIComponent(first) +
            "&next=" + encodeURIComponent(JSON.stringify(queue));
        return;
    }

    /* --------------------------
       â˜… ëª¨ë“  ì¢Œí‘œ ì¤€ë¹„ ì™„ë£Œ
       â†’ ë‹¤ì¤‘ YOLO ë¶„ì„ ì‹œì‘
    -------------------------- */
    document.getElementById("stopBtn").disabled = false;

    await fetch("/process_yolo_multi", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ videos: selected })
    });

    alert("ë‹¤ì¤‘ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.");

    pollMulti();
}

/* --------------------------------
   ì¤‘ì§€
-------------------------------- */
async function stopProcess() {
    document.getElementById('status').innerText = 'ì¤‘ì§€ ìš”ì²­ ì¤‘...';
    document.getElementById('stopBtn').disabled = true;
    try {
        await fetch('/stop', { method: 'POST' });
    } catch (e) {}
}

function goCrossEdit() {
    window.location.href = "/full";
}

/* ============================================
   ğŸ”¥ğŸ”¥ ë‹¤ì¤‘ ë¶„ì„ ì§„í–‰ë¥  poll() ìƒˆë¡œ ì‘ì„±
============================================ */
async function pollMulti() {
    const res = await fetch('/progress_multi?ts=' + Date.now(), { cache: 'no-store' });
    const data = await res.json();

    const bar = document.getElementById("bar");
    const status = document.getElementById("status");

    bar.value = data.progress || 0;

    status.innerText =
        `ìƒíƒœ: ${data.status} / ì˜ìƒ ${data.current_index}/${data.total} ` +
        `(ì§„í–‰ë¥  ${data.progress || 0}%)`;

    // ì˜ìƒ í•˜ë‚˜ ì™„ë£Œë¨
    if (data.status === "done") {
        // ë‹¤ìŒ ì˜ìƒ ìë™ ì‹œì‘ â†’ ì„œë²„ì—ì„œ í•´ê²°
        return setTimeout(pollMulti, 1000);
    }

    // ëª¨ë“  ì˜ìƒ ì™„ë£Œ
    if (data.status === "done_all") {
        alert("ëª¨ë“  ì˜ìƒ ë¶„ì„ ì™„ë£Œ!");

        // ë§ˆì§€ë§‰ ì˜ìƒì˜ result_pageë¡œ ì´ë™
        const clipsEncoded = encodeURIComponent(JSON.stringify(data.clips || []));
        window.location.href =
            '/result_page?video=' + encodeURIComponent(data.current_video) +
            '&clips=' + clipsEncoded;
        return;
    }

    // ì—ëŸ¬ ë˜ëŠ” ì¤‘ì§€
    if (data.status === "stopped" || (data.status || "").startsWith("error")) {
        document.getElementById('stopBtn').disabled = true;
        return;
    }

    // ê³„ì† í´ë§
    setTimeout(pollMulti, 800);
}

/* í˜ì´ì§€ ë– ë‚  ë•Œ ë¶„ì„ ì¤‘ì§€ */
window.addEventListener('beforeunload', function () {
    navigator.sendBeacon('/stop');
});

/* =============================
   ğŸ”¥ ì˜ìƒ ì—…ë¡œë“œ ê¸°ëŠ¥
============================= */
async function uploadVideos() {
    const files = document.getElementById('uploadFile').files;
    if (!files.length) {
        alert("ì—…ë¡œë“œí•  ì˜ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
    }

    const formData = new FormData();
    for (const f of files) formData.append("files", f);

    document.getElementById("uploadStatus").innerText = "ì—…ë¡œë“œ ì¤‘...";

    const res = await fetch("/upload_video", {
        method: "POST",
        body: formData
    });

    const data = await res.json();

    if (data.error) {
        document.getElementById("uploadStatus").innerText = "âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: " + data.error;
        return;
    }

    document.getElementById("uploadStatus").innerText = "ì—…ë¡œë“œ ì™„ë£Œ! ëª©ë¡ ê°±ì‹  ì¤‘...";

    // ğŸ”¥ ì—…ë¡œë“œ ì„±ê³µ â†’ ì˜ìƒ ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨
    refreshVideoList();
}

/* =============================
   ğŸ”¥ ì˜ìƒ ëª©ë¡ ê°±ì‹  ê¸°ëŠ¥
============================= */
async function refreshVideoList() {
    const res = await fetch("/videos_list");
    const list = await res.json();

    const sel = document.getElementById("video");
    sel.innerHTML = "";

    list.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
    });

    document.getElementById("uploadStatus").innerText = "ì—…ë¡œë“œ ì™„ë£Œ!";
}



</script>
</body>
</html>
