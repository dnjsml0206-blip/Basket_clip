<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>YOLO í•˜ì´ë¼ì´íŠ¸ ë¶„ì„ê¸°</title>
    <style>
    body { background:#111; color:white; font-family:sans-serif; text-align:center; margin-top:40px; }
    select,button { padding:10px; margin:10px; border-radius:6px; }
    progress { width:80%; height:30px; margin-top:10px; }
    #status { margin-top:10px; font-size:18px; }
    </style>
</head>
<body>
    <h2>ğŸ€ YOLO í•˜ì´ë¼ì´íŠ¸ ë¶„ì„ê¸°</h2>

    <select id="video" name="video" multiple size="6">
        {% for v in videos %}
        <option value="{{v}}">{{v}}</option>
        {% endfor %}
    </select><br>

    <button onclick="selectBasket()">ê³¨ëŒ€ ì¢Œí‘œ ì„ íƒ</button>
    <button onclick="start()">ë¶„ì„ ì‹œì‘</button>
    <button id="stopBtn" onclick="stopProcess()" disabled>ì¤‘ì§€</button>
    <button onclick="goCrossEdit()">ì¢Œ/ìš° ê³¨ëŒ€ êµì°¨ í¸ì§‘</button>

    <div id="status">ëŒ€ê¸° ì¤‘...</div>
    <progress id="bar" value="0" max="100"></progress>

    <h3 style="margin-top:40px;">ğŸ“ ì €ì¥ëœ ë¶„ì„</h3>
    <div id="savedList"></div>

    <script>

    fetch("/saved")
    .then(r => r.json())
    .then(list => {
        const box = document.getElementById("savedList");
        box.innerHTML = "";

        list.forEach(item => {
        const div = document.createElement("div");
        div.style.margin = "6px";

        const cleanName = item.video.replace(/\.[^/.]+$/, "");  // í™•ì¥ì ì œê±°

        div.innerHTML = `
            <a href="/result_page?video=${encodeURIComponent(item.video)}&clips=${encodeURIComponent(JSON.stringify(item.clips || []))}"
            style="color:#0ff; text-decoration:none;">
            <b>${cleanName}</b>
            </a>
            (${item.created})
            <button onclick="delSaved('${item.id}')">ì‚­ì œ</button>
        `;

        box.appendChild(div);
        });
    });

    function delSaved(id) {
    fetch("/saved/" + id, { method: "DELETE" })
        .then(() => location.reload());
    }

    let polling = false;

    async function selectBasket() {
        const video = document.getElementById('video').value;
        if (!video) {
            alert("ì˜ìƒì„ ì„ íƒí•˜ì„¸ìš”!");
            return;
        }
        window.location.href = '/select_basket?video=' + encodeURIComponent(video);
    }

    async function start() {
        const sel = document.getElementById("video");
        const selected = [...sel.options].filter(o => o.selected).map(o => o.value);

        if (selected.length === 0) {
            alert("ì˜ìƒì„ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”!");
            return;
        }

        // ì¢Œí‘œ ì—†ëŠ” ì˜ìƒ ì²´í¬
        let missing = [];
        let needReset = [];

        for (const v of selected) {
            const coords = await fetch('/basket_coords?video=' + encodeURIComponent(v))
                                .then(r => r.json())
                                .catch(() => null);

            // ì—†ìœ¼ë©´ missing ë¦¬ìŠ¤íŠ¸ì—
            if (!coords || !coords.x1) {
                missing.push(v);
                continue;
            }

            // ê¸°ì¡´ ì¢Œí‘œ ìˆìŒ â†’ ì¬ì„¤ì •í• ì§€ ë¬¼ì–´ë³´ê¸°
            const reset = confirm(`${v} ì˜ìƒì€ ê¸°ì¡´ ê³¨ëŒ€ ì¢Œí‘œê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\nì¬ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (reset) needReset.push(v);
        }

        // 1) ì¢Œí‘œ ì¬ì„¤ì •í•  ì˜ìƒ ë¨¼ì € ì²˜ë¦¬
        if (needReset.length > 0) {
            const v = needReset[0];
            window.location.href = "/select_basket?video=" + encodeURIComponent(v) +
                                "&next=" + encodeURIComponent(JSON.stringify(needReset.slice(1).concat(missing)));
            return;
        }

        // 2) ì¢Œí‘œ ì—†ëŠ” ì˜ìƒ ì²˜ë¦¬
        if (missing.length > 0) {

            if (missing.length === 1) {
                const ok = confirm(`ë‹¤ìŒ ì˜ìƒì˜ ê³¨ëŒ€ ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤:\n${missing[0]}\nì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                if (!ok) return;

                window.location.href = "/select_basket?video=" + encodeURIComponent(missing[0]);
                return;
            }

            // 2ê°œ ì´ìƒ â†’ ìˆœì°¨ ì„¤ì •
            const first = missing[0];
            const queue = missing.slice(1);
            alert(`ë‹¤ìŒ ì˜ìƒë“¤ì— ê³¨ëŒ€ ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤.\nìˆœì„œëŒ€ë¡œ ì„¤ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤.\n1: ${first}`);

            window.location.href = "/select_basket?video=" + encodeURIComponent(first) +
                                "&next=" + encodeURIComponent(JSON.stringify(queue));
            return;
        }

        // 3) ëª¨ë“  ì˜ìƒ ê³¨ëŒ€ ì¤€ë¹„ ì™„ë£Œ â†’ YOLO ë¶„ì„ ì‹œì‘
        for (const v of selected) {
            await fetch('/process_yolo?video=' + encodeURIComponent(v));
        }

        alert("ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
        if (!polling) poll();
    }


    async function stopProcess() {
        document.getElementById('status').innerText = 'ì¤‘ì§€ ìš”ì²­ ì¤‘...';
        document.getElementById('stopBtn').disabled = true;
        try {
            await fetch('/stop', { method: 'POST' });
        } catch (e) {}
    }

    function goCrossEdit() {
        window.location.href = "/full";
    }

    /* ğŸ‘‡ ìˆ˜ì •ëœ í•µì‹¬ poll í•¨ìˆ˜ */
    async function poll() {
        polling = true;
        const res = await fetch('/progress?ts=' + Date.now(), { cache: 'no-store' });
        const data = await res.json();

        document.getElementById('bar').value = data.progress || 0;
        document.getElementById('status').innerText =
            'ìƒíƒœ: ' + data.status + ' (' + (data.progress || 0) + '%)';

        if (data.status === 'done') {
            document.getElementById('stopBtn').disabled = true;

            const clipsEncoded = encodeURIComponent(JSON.stringify(data.clips || []));

            window.location.href =
                '/result_page?video=' + encodeURIComponent(data.video) +
                '&clips=' + clipsEncoded;

            polling = false;
            return;
        }

        if (data.status === 'stopped') {
            document.getElementById('stopBtn').disabled = true;
            polling = false;
            return;
        }

        if (data.status && data.status.startsWith('error')) {
            document.getElementById('stopBtn').disabled = true;
            polling = false;
            return;
        }

        setTimeout(poll, 1000);
    }

    window.addEventListener('beforeunload', function () {
        navigator.sendBeacon('/stop');
    });
    </script>
</body>
</html>
