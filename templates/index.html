<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>YOLO í•˜ì´ë¼ì´íŠ¸ ë¶„ì„ê¸°</title>
    <style>
    body { background:#111; color:white; font-family:sans-serif; text-align:center; margin-top:40px; }
    select,button { padding:10px; margin:10px; border-radius:6px; }
    progress { width:80%; height:30px; margin-top:10px; }
    #status { margin-top:10px; font-size:18px; }
    </style>
</head>
<body>
    <h2>ğŸ€ YOLO í•˜ì´ë¼ì´íŠ¸ ë¶„ì„ê¸°</h2>

    <!-- ğŸ”¥ ì˜ìƒ ì—…ë¡œë“œ ê¸°ëŠ¥ -->
    <h3>ğŸ“¤ ì˜ìƒ ì—…ë¡œë“œ</h3>

    <input type="file" id="uploadFile" accept="video/*" multiple>
    <button onclick="uploadVideos()">ì˜ìƒ ì—…ë¡œë“œ</button>

    <div id="uploadList" style="margin-top:20px; text-align:left; width:60%; margin:auto;"></div>

    <hr style="width:60%; margin:20px auto;">


    <div style="width:60%; margin:10px auto;">
        <progress id="uploadProgress" value="0" max="100" style="width:100%; height:25px; display:none;"></progress>
        <div id="uploadProgressText" style="margin-top:5px; font-size:16px;"></div>
    </div>


    <!-- ğŸ“Œ ì˜ìƒ ì„ íƒ + ì—…ë¡œë“œ ë¦¬ìŠ¤íŠ¸ ì¢Œ/ìš° ë ˆì´ì•„ì›ƒ -->
    <div style="display:flex; justify-content:center; gap:40px; margin-top:30px;">

        <!-- ì™¼ìª½ : ë¶„ì„í•  ì˜ìƒ ì„ íƒ -->
        <div>
            <h3 style="margin-bottom:8px;">ğŸ ë¶„ì„í•  ì˜ìƒ ì„ íƒ</h3>
            <select id="video" name="video" multiple size="10" 
                    style="padding:6px; width:220px;">
                {% for v in videos %}
                <option value="{{v}}">{{v}}</option>
                {% endfor %}
            </select>
        </div>

        <!-- ì˜¤ë¥¸ìª½ : ì—…ë¡œë“œëœ ì˜ìƒ ëª©ë¡ + ì‚­ì œ ë²„íŠ¼ -->
        <div>
            <h3 style="margin-bottom:8px;">ğŸ“ ì—…ë¡œë“œëœ ì˜ìƒ ëª©ë¡</h3>
            <div id="videoDeleteList"
                style="text-align:left; width:260px; min-height:200px;">
                <!-- JSì—ì„œ ì˜ìƒ ë¦¬ìŠ¤íŠ¸ ìë™ ë Œë”ë§ë¨ -->
            </div>
        </div>

    </div>



    <button onclick="selectBasket()">ê³¨ëŒ€ ì¢Œí‘œ ì„ íƒ</button>
    <button onclick="start()">ë¶„ì„ ì‹œì‘</button>
    <button id="stopBtn" onclick="stopProcess()" disabled>ì¤‘ì§€</button>
    <button onclick="goCrossEdit()">ì¢Œ/ìš° ê³¨ëŒ€ êµì°¨ í¸ì§‘</button>
    <button onclick="endAnalysis()">ğŸ”š ë¶„ì„ ì¢…ë£Œ</button>

    <div id="status">ëŒ€ê¸° ì¤‘...</div>
    <progress id="bar" value="0" max="100"></progress>

    <h3 style="margin-top:40px;">ğŸ“ ì €ì¥ëœ ë¶„ì„</h3>
    <div id="savedList"></div>

<script>
/* ------------------------------
   ì €ì¥ëœ ë¶„ì„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
------------------------------ */
fetch("/saved")
.then(r => r.json())
.then(list => {
    const box = document.getElementById("savedList");
    box.innerHTML = "";

    list.forEach(item => {
        const cleanName = item.video.replace(/\.[^/.]+$/, "");
        const div = document.createElement("div");
        div.style.margin = "6px";

        div.innerHTML = `
            <a href="/result_page?video=${encodeURIComponent(item.video)}&clips=${encodeURIComponent(JSON.stringify(item.clips || []))}"
                style="color:#0ff; text-decoration:none;">
                <b>${cleanName}</b>
            </a>
            (${item.created})
            <button onclick="delSaved('${item.id}')">ì‚­ì œ</button>
        `;

        box.appendChild(div);
    });
});

function delSaved(id) {
    fetch("/saved/" + id, { method: "DELETE" })
        .then(() => location.reload());
}

/* ------------------------------
   ê³¨ëŒ€ ì¢Œí‘œ ì„ íƒ
------------------------------ */
async function selectBasket() {
    const video = document.getElementById('video').value;
    if (!video) {
        alert("ì˜ìƒì„ ì„ íƒí•˜ì„¸ìš”!");
        return;
    }
    window.location.href = '/select_basket?video=' + encodeURIComponent(video);
}

/* ============================================
   ğŸ”¥ğŸ”¥ ë‹¤ì¤‘ ì˜ìƒ ë¶„ì„ í•µì‹¬ start() ì¬ì‘ì„±
============================================ */
async function start() {
    const sel = document.getElementById("video");
    const selected = [...sel.options].filter(o => o.selected).map(o => o.value);

    if (selected.length === 0) {
        alert("ì˜ìƒì„ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”!");
        return;
    }

    // ì¢Œí‘œ ì²´í¬
    let missing = [];
    let needReset = [];

    for (const v of selected) {
        const coords = await fetch('/basket_coords?video=' + encodeURIComponent(v))
                            .then(r => r.json())
                            .catch(() => null);

        if (!coords || !coords.x1) {
            missing.push(v);
            continue;
        }

        const reset = confirm(`${v} ì˜ìƒì€ ê¸°ì¡´ ê³¨ëŒ€ ì¢Œí‘œê°€ ìˆìŠµë‹ˆë‹¤.\nì¬ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
        if (reset) needReset.push(v);
    }

    // ì¬ì„¤ì • í•„ìš”í•œ ì˜ìƒ
    if (needReset.length > 0) {
        const v = needReset[0];
        window.location.href =
            "/select_basket?video=" + encodeURIComponent(v) +
            "&next=" + encodeURIComponent(JSON.stringify(needReset.slice(1).concat(missing)));
        return;
    }

    // ì¢Œí‘œ ì—†ëŠ” ì˜ìƒ ì²˜ë¦¬
    if (missing.length > 0) {
        if (missing.length === 1) {
            const ok = confirm(`ë‹¤ìŒ ì˜ìƒì˜ ê³¨ëŒ€ ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤:\n${missing[0]}\nì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!ok) return;

            window.location.href =
                "/select_basket?video=" + encodeURIComponent(missing[0]);
            return;
        }

        const first = missing[0];
        const queue = missing.slice(1);
        alert(`ë‹¤ìŒ ì˜ìƒë“¤ì— ê³¨ëŒ€ ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤.\nìˆœì„œëŒ€ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.\n1: ${first}`);

        window.location.href =
            "/select_basket?video=" + encodeURIComponent(first) +
            "&next=" + encodeURIComponent(JSON.stringify(queue));
        return;
    }

    /* --------------------------
       â˜… ëª¨ë“  ì¢Œí‘œ ì¤€ë¹„ ì™„ë£Œ
       â†’ ë‹¤ì¤‘ YOLO ë¶„ì„ ì‹œì‘
    -------------------------- */
    document.getElementById("stopBtn").disabled = false;

    await fetch("/process_yolo_multi", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ videos: selected })
    });

    alert("ë‹¤ì¤‘ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.");

    pollMulti();
}

/* --------------------------------
   ì¤‘ì§€
-------------------------------- */
async function stopProcess() {
    document.getElementById('status').innerText = 'ì¤‘ì§€ ìš”ì²­ ì¤‘...';
    document.getElementById('stopBtn').disabled = true;
    try {
        await fetch('/stop', { method: 'POST' });
    } catch (e) {}
}

function goCrossEdit() {
    window.location.href = "/full";
}

/* ============================================
   ğŸ”¥ğŸ”¥ ë‹¤ì¤‘ ë¶„ì„ ì§„í–‰ë¥  poll() ìƒˆë¡œ ì‘ì„±
============================================ */
async function pollMulti() {
    const res = await fetch('/progress_multi?ts=' + Date.now(), { cache: 'no-store' });
    const data = await res.json();

    const bar = document.getElementById("bar");
    const status = document.getElementById("status");

    bar.value = data.progress || 0;

    status.innerText =
        `ìƒíƒœ: ${data.status} / ì˜ìƒ ${data.current_index}/${data.total} ` +
        `(ì§„í–‰ë¥  ${data.progress || 0}%)`;

    // ì˜ìƒ í•˜ë‚˜ ì™„ë£Œë¨
    if (data.status === "done") {
        // ë‹¤ìŒ ì˜ìƒ ìë™ ì‹œì‘ â†’ ì„œë²„ì—ì„œ í•´ê²°
        return setTimeout(pollMulti, 1000);
    }

    // ëª¨ë“  ì˜ìƒ ì™„ë£Œ
    if (data.status === "done_all") {
        alert("ëª¨ë“  ì˜ìƒ ë¶„ì„ ì™„ë£Œ!");

        // ë§ˆì§€ë§‰ ì˜ìƒì˜ result_pageë¡œ ì´ë™
        const clipsEncoded = encodeURIComponent(JSON.stringify(data.clips || []));
        window.location.href =
            '/result_page?video=' + encodeURIComponent(data.current_video) +
            '&clips=' + clipsEncoded;
        return;
    }

    // ì—ëŸ¬ ë˜ëŠ” ì¤‘ì§€
    if (data.status === "stopped" || (data.status || "").startsWith("error")) {
        document.getElementById('stopBtn').disabled = true;
        return;
    }

    // ê³„ì† í´ë§
    setTimeout(pollMulti, 800);
}

/* í˜ì´ì§€ ë– ë‚  ë•Œ ë¶„ì„ ì¤‘ì§€ */
window.addEventListener('beforeunload', function () {
    navigator.sendBeacon('/stop');
});

/* =============================
   ğŸ”¥ ì˜ìƒ ì—…ë¡œë“œ ê¸°ëŠ¥
============================= */
async function uploadVideos() {
    const files = document.getElementById('uploadFile').files;
    if (!files.length) {
        alert("ì—…ë¡œë“œí•  ì˜ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
    }

    const uploadBox = document.getElementById("uploadList");
    uploadBox.innerHTML = ""; // ê¸°ì¡´ UI ì´ˆê¸°í™”

    let completedCount = 0;

    for (const file of files) {
        // ê° íŒŒì¼ë³„ UI ë§Œë“¤ê¸°
        const row = document.createElement("div");
        row.style.margin = "8px 0";
        row.innerHTML = `
            <div><b>${file.name}</b></div>
            <progress value="0" max="100" style="width:100%; height:20px;"></progress>
            <div class="percent" style="font-size:14px; color:#0f0;"></div>
        `;
        uploadBox.appendChild(row);

        const progressEl = row.querySelector("progress");
        const percentEl = row.querySelector(".percent");

        // íŒŒì¼ë³„ ì—…ë¡œë“œ (XHR)
        const formData = new FormData();
        formData.append("files", file);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload_video", true);

        // ê°œë³„ íŒŒì¼ ì—…ë¡œë“œ progress
        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressEl.value = percent;
                percentEl.innerText = `${percent}%`;
            }
        };

        xhr.onload = () => {
            if (xhr.status === 200) {
                percentEl.innerText = "âœ” ì—…ë¡œë“œ ì™„ë£Œ";
                percentEl.style.color = "#0f0";
            } else {
                percentEl.innerText = "âŒ ì‹¤íŒ¨";
                percentEl.style.color = "red";
            }

            completedCount++;
            if (completedCount === files.length) {
                setTimeout(() => {
                    refreshVideoList();
                    loadDeleteList();
                }, 500);
            }
        };

        xhr.onerror = () => {
            percentEl.innerText = "âŒ ì˜¤ë¥˜ ë°œìƒ";
            percentEl.style.color = "red";
        };

        xhr.send(formData);
    }
}



/* =============================
   ğŸ”¥ ì˜ìƒ ëª©ë¡ ê°±ì‹  ê¸°ëŠ¥
============================= */
async function refreshVideoList() {
    const res = await fetch("/videos_list");
    const list = await res.json();

    const sel = document.getElementById("video");
    sel.innerHTML = "";

    list.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
    });

    document.getElementById("uploadStatus").innerText = "ì—…ë¡œë“œ ì™„ë£Œ!";
}

function endAnalysis() {
    if (!confirm("ì •ë§ ë¶„ì„ì„ ì¢…ë£Œí•˜ê³  ëª¨ë“  ì‘ì—…ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;

    fetch("/end_analysis", {
        method: "POST"
    }).then(() => {
        window.location.href = "/";   // í™ˆìœ¼ë¡œ ì´ë™
    });
}

async function loadDeleteList() {
    const res = await fetch("/videos_list");
    const videos = await res.json();

    const box = document.getElementById("videoDeleteList");
    box.innerHTML = "";

    videos.forEach(v => {
        const div = document.createElement("div");
        div.style.margin = "6px";

        div.innerHTML = `
            ğŸ¬ ${v}
            <button onclick="deleteVideo('${v}')"
                style="margin-left:10px; padding:4px 8px; background:#a00; color:white; border:none; border-radius:4px;">
                ì‚­ì œ
            </button>
        `;

        box.appendChild(div);
    });
}

async function deleteVideo(filename) {
    if (!confirm(`${filename} ì„(ë¥¼) ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    await fetch("/delete_video", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ filename })
    });

    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");

    // ì˜ìƒ ì„ íƒ ëª©ë¡ & ì‚­ì œ ëª©ë¡ ë‘˜ ë‹¤ ë‹¤ì‹œ ë¡œë“œ
    refreshVideoList();
    loadDeleteList();
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë¡œë“œ
loadDeleteList();



</script>
</body>
</html>
